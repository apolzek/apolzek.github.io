<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <link rel="stylesheet" href="/assets/css/syntax.css"> <link rel="preconnect" href="https://cdnjs.cloudflare.com"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> <title> Observabilidade na pr√°tica - apolzek </title> <link rel="preconnect" href="https://fonts.gstatic.com"> <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap" rel="stylesheet"> <link rel="shortcut icon" href="/apolzek.ico"> <link rel="alternate" type="application/atom+xml" title="apolzek" href="/atom.xml"> <link rel="alternate" type="application/json" title="apolzek" href="/feed.json" /> <link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /> <style> *, :after, :before { box-sizing: border-box; background-color: inherit; color: inherit; margin: 0; padding: 0; } html { font-size: 15px; } #theme-toggle { opacity: 0.65; position: relative; border-radius: 5px; height: 25px; display: flex; -webkit-box-align: center; align-items: center; -webkit-box-pack: center; justify-content: center; transition: opacity 0.3s ease 0s; border: none; outline: none; background: none; cursor: pointer; padding: 0px; appearance: none; transform: scale(0.8); } html, html[data-theme="light"] { --very-light-text-color: rgb(222, 222, 222); --light-text-color: rgb(196, 187, 240); --medium-text-color: #555; --main-text-color: #333; --dark-text-color: #393e46; --link-color: rgb(70, 10, 196); --code-bg-color: rgb(240, 240, 240); background-color: white; } html #theme-toggle div, html[data-theme="light"] #theme-toggle div { position: relative; width: 24px; height: 24px; border-radius: 50%; border: none; background-color: var(--theme-ui-colors-transparent, transparent); transform: scale(1); transition: all 0.45s ease 0s; overflow: hidden; box-shadow: inset 8px -8px 0px 0px var(--theme-ui-colors-toggleIcon, #2d3748); } html #theme-toggle div::before, html[data-theme="light"] #theme-toggle div::before { content: ""; position: absolute; right: -9px; top: -9px; height: 24px; width: 24px; border: none; border-radius: 50%; transform: translate(0px, 0px); opacity: 1; transition: transform 0.45s ease 0s; } html #theme-toggle div::after, html[data-theme="light"] #theme-toggle div::after { content: ""; width: 8px; height: 8px; border-radius: 50%; margin: -4px 0px 0px -4px; position: absolute; top: 50%; left: 50%; box-shadow: 0 -23px 0 var(--theme-ui-colors-toggleIcon, #2d3748), 0 23px 0 var(--theme-ui-colors-toggleIcon, #2d3748), 23px 0 0 var(--theme-ui-colors-toggleIcon, #2d3748), -23px 0 0 var(--theme-ui-colors-toggleIcon, #2d3748), 15px 15px 0 var(--theme-ui-colors-toggleIcon, #2d3748), -15px 15px 0 var(--theme-ui-colors-toggleIcon, #2d3748), 15px -15px 0 var(--theme-ui-colors-toggleIcon, #2d3748), -15px -15px 0 var(--theme-ui-colors-toggleIcon, #2d3748); transform: scale(0); transition: all 0.35s ease 0s; } html[data-theme="dark"] { --very-light-text-color: rgb(200,200,200); --light-text-color: #c4bbf0; --medium-text-color: #52057b; --main-text-color: rgb(244,244,244); --dark-text-color: rgb(36, 38, 42); --link-color: rgb(255, 0, 163); --code-bg-color: rgb(60, 60, 60); background-color: #131418; } html[data-theme="dark"] #theme-toggle div { position: relative; width: 24px; height: 24px; border-radius: 50%; border: 4px solid var(--theme-ui-colors-toggleIcon, #cbd5e0); background-color: var(--theme-ui-colors-toggleIcon, #cbd5e0); transform: scale(0.55); transition: all 0.45s ease 0s; overflow: visible; box-shadow: none; } html[data-theme="dark"] #theme-toggle div::before { content: ""; position: absolute; right: -9px; top: -9px; height: 24px; width: 24px; border: 2px solid var(--theme-ui-colors-toggleIcon, #cbd5e0); border-radius: 50%; transform: translate(14px, -14px); opacity: 0; transition: transform 0.45s ease 0s; } html[data-theme="dark"] #theme-toggle div::after { content: ""; width: 8px; height: 8px; border-radius: 50%; margin: -4px 0px 0px -4px; position: absolute; top: 50%; left: 50%; box-shadow: 0 -23px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0), 0 23px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0), 23px 0 0 var(--theme-ui-colors-toggleIcon, #cbd5e0), -23px 0 0 var(--theme-ui-colors-toggleIcon, #cbd5e0), 15px 15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0), -15px 15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0), 15px -15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0), -15px -15px 0 var(--theme-ui-colors-toggleIcon, #cbd5e0); transform: scale(1); transition: all 0.35s ease 0s; } body { font-family: "Fira Code", monospace; text-rendering: optimizeLegibility; line-height: 1.75; color: var(--main-text-color); } a { color: var(--link-color); text-decoration: none; } .post p { margin: 1rem 0; } .meta { margin: 1.4rem 0; } code, pre { background: var(--code-bg-color); margin: 0 -27px; border-width: 1px; } code { margin: unset; padding: 0.1rem; } pre code { background-color: unset; color: unset; } pre { overflow-x: scroll; border-width: 5px; padding: 0.8rem; border-radius: 5px; border-style: none none none solid; border-color: var(--link-color); } img { max-width: 100%; display: block; margin-left: auto; margin-right: auto; } hr { background: var(--light-text-color); height: 1px; border: 0; } header { flex-basis: 10rem; flex-grow: 1; position: relative; } header a { text-decoration: none; } header li { margin-bottom: 0.2rem; text-align: right; margin-right: 2rem; } header a.active { font-weight: bold; } header, section { padding: 1rem 0; } section { margin-top: 5.5rem; } blockquote { font-style: italic; border-left: 5px solid var(--dark-text-color); padding-left: 1rem; } h1 { color: var(--main-text-color); font-size: 1.4rem; font-weight: bold; margin-bottom: 1rem; margin-top: 1.5rem; } h2 { font-weight: bold; font-size: 1.3rem; margin-bottom: 1rem; margin-top: 1.5rem; } h3, h4, h5 { font-weight: bold; margin-bottom: 1rem; margin-top: 1.5rem; } section h1:first-child { margin-top: 0; } strong, b { font-weight: bold; } .photos ul { list-style: none; } .photos li { margin-bottom: 1.5rem; } .photo picture, .project picture { margin-bottom: 0.5rem; } .posts > h3 { font-weight: 500; } .posts ul, header ul { list-style: none; } .posts li { align-items: center; display: flex; justify-content: space-between; margin-bottom: 0.5rem; } .posts li a, .posts li div, .projects li a { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; } .posts li time, .projects li time { padding-left: 1rem; white-space: nowrap; font-variant-numeric: tabular-nums; } time { color: var(--main-text-color); } .post > h1.title { font-size: x-large; margin-top: 0; margin-bottom: 0; } .post > time { margin-bottom: 0; margin-top: 3rem; } main { display: flex; max-width: 47rem; margin: -5rem auto 0; padding: 2.4rem 2rem; flex-direction: column; } .flex-row-between { display: flex; flex-direction: row; justify-content: space-between; } .social-footer { padding: 1rem; display: flex; justify-content: center; position: initial; } .social-footer .social-footer-icons .fa { font-size: 1.3rem; color: #a9a9a9; } .social-footer .social-footer-icons .fa:hover { color: dimgray; transition: color 0.3s ease-in; } @media screen and (max-width: 45rem) { header li { display: inline; margin-right: 1rem; } .logo { padding-bottom: 1rem; } header ul { border-bottom: 1px solid #edf2f7; padding-bottom: 2rem; } nav ul { border-right: 0px; } .photos ul { margin-top: 0.5rem; } main { padding: 0 2rem; } } section { flex-grow: 999; display: flex; flex-direction: column; } figcaption { font-size: smaller; } .bio { margin-bottom: 5rem; } ::selection { background-color: #fffba0; color: #333; } .search-article { position: relative; } .search-article label[for="search-input"] { position: relative; top: -10px; left: 11px; } .search-article input[type="search"] { top: -1rem; left: 0; border: 0; width: 100%; height: 30px; outline: none; position: absolute; border-radius: 5px; padding: 10px 10px 10px 35px; color: var(--main-text-color); -webkit-appearance: none; background-color: rgba(128, 128, 128, 0.1); border: 1px solid rgba(128, 128, 128, 0.1); } .search-article input[type="search"]::-webkit-input-placeholder { color: #808080; } .search-article input[type="search"]::-webkit-search-decoration, .search-article input[type="search"]::-webkit-search-results-decoration { display: none; } #search-results { text-align: center; } #search-results li { text-align: center; } .post-nav { display: flex; position: relative; margin-top: 0; border-top: 2px solid var(--light-text-color); line-height: 1.4; } .post-nav .post-nav-item { border-bottom: 0; padding-bottom: 10px; width: 50%; padding-top: 10px; text-decoration: none; box-sizing: border-box; } .post-nav .post-nav-item .post-title { color: var(--main-text-color); } .post-nav .post-nav-item:hover .post-title, .post-nav .post-nav-item:focus .post-title { color: var(--link-color); opacity: 0.9; } .post-nav .post-nav-item .nav-arrow { font-size: 17px; color: var(--main-text-color); margin-bottom: 3px; font-weight: bold; } .post-nav .post-nav-item:nth-child(odd) { padding-left: 0; padding-right: 20px; } .post-nav .post-nav-item:nth-child(even) { text-align: right; padding-right: 0; padding-left: 20px; } .tags ul { list-style: none; display: grid; grid-template-columns: auto auto auto auto auto auto; grid-template-rows: auto auto auto auto; } .tags li { white-space: normal; text-overflow: ellipsis; } .timeline { position: center; width: 650px; margin: -6em auto; padding: 1px; list-style-type: none; } @media (max-width: 860px) { .timeline { width: 100%; } } .timeline:before { position: fixed; left: 50%; top: 100px; bottom: 30px; content: " "; display: block; width: 6px; height: 15%; border-style: dashed; margin-left: -3px; color: var(--light-text-color); } @media (max-width: 375px) { .timeline:before { height: 150%; } } .timeline li { padding: 2em 0; } @media (max-width: 860px) { .timeline li { padding: 2em 0; } } .timeline li::after { content: ""; display: block; clear: both; visibility: hidden; } .direction-l { position: relative; width: 287px; float: left; text-align: right; } @media (max-width: 860px) { .direction-l { float: none; width: 100%; text-align: center; } } .direction-l .flag { color: #333; box-shadow: -1px 1px 1px rgba(0, 0, 0, 0.52); } .direction-l .flag:after { content: ""; position: absolute; left: 100%; top: 50%; height: 0; width: 0; margin-top: -8px; border: solid transparent; border-left-color: #f8f8f8; border-width: 8px; pointer-events: none; } @media (max-width: 860px) { .direction-l .flag:after { content: ""; position: absolute; left: 50%; top: -8px; height: 0; width: 0; margin-left: -8px; border: solid transparent; border-bottom-color: white; border-width: 8px; pointer-events: none; } } .direction-l .time-wrapper { float: left; } @media (max-width: 860px) { .direction-l .time-wrapper { float: none; } } .direction-r { position: relative; width: 293px; float: right; text-align: left; } @media (max-width: 860px) { .direction-r { float: none; width: 100%; text-align: center; } } .direction-r .flag { color: #333; box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.52); } .direction-r .flag:after { content: ""; position: absolute; right: 100%; top: 50%; height: 0; width: 0; margin-top: -8px; border: solid transparent; border-right-color: #f8f8f8; border-width: 8px; pointer-events: none; } @media (max-width: 860px) { .direction-r .flag:after { content: ""; position: absolute; left: 50%; top: -8px; height: 0; width: 0; margin-left: -8px; border: solid transparent; border-bottom-color: white; border-width: 8px; pointer-events: none; } } .direction-r .flag:before { left: -40px; } .direction-r .time-wrapper { float: right; } @media (max-width: 860px) { .direction-r .time-wrapper { float: none; } } .flag-wrapper { position: relative; display: inline-block; text-align: center; } @media (max-width: 860px) { .flag-wrapper { text-align: center; } } .flag-wrapper .flag { position: relative; display: inline; background: #f8f8f8; padding: 6px 10px; border-radius: 5px; font-weight: 600; text-align: left; } @media (max-width: 860px) { .flag-wrapper .flag { background: white; z-index: 15; } } .direction-l .flag:before, .direction-r .flag:before { position: absolute; top: 60%; right: -40px; content: ' '; display: block; width: 12px; height: 12px; margin-top: -10px; background: #fff; border-radius: 10px; border: 4px solid var(--link-color); z-index: 10; } @media (max-width: 860px) { .direction-l .flag:before, .direction-r .flag:before { position: absolute; top: -30px; left: 53%; content: ' '; display: block; margin-left: -10px; } } .time-wrapper { display: inline; line-height: 1em; font-size: 0.66666em; color: var(--link-color); vertical-align: middle; } @media (max-width: 860px) { .time-wrapper { display: block; position: relative; margin: 4px 0 0 0; z-index: 14; } } .time-wrapper .time { display: inline-block; padding: 4px 6px; background: #f8f8f8; } .desc { margin: 1em 0.2em -3.5em 0; font-size: 0.9em; line-height: 1.5em; } .desc a { color: var(--link-color); text-decoration: none; } .desc a:hover { text-decoration: underline; } @media (max-width: 860px) { .desc { position: relative; margin: 1em 1em 0 1em; padding: 1em; background: var(--code-bg-color); box-shadow: 0 0 1px rgba(0, 0, 0, 0.2); z-index: 15; } } </style> </head> <body> <main> <section class="post"> <div class="flex-row-between"> <a href="/"><i class="fa fa-chevron-circle-left" aria-hidden="true"></i> home</a> <button title="Change theme" id="theme-toggle" onclick="modeSwitcher()"> <div></div> </button> </div> <time datetime=""> - 7' read</time> <h1 class="title"> Observabilidade na pr√°tica </h1> <span class="meta"> <a href="/tag/Observabilidade OpenTelemetry Grafana Loki Tempo Promtail Flask Jaeger Zipkin Prometheus">Observabilidade OpenTelemetry Grafana Loki Tempo Promtail Flask Jaeger Zipkin Prometheus</a></span> <p>Eae..</p> <p>o objetivo desse artigo √© mostrar um caminho(na pr√°tica) para se conseguir Observabilidade em duas aplica√ß√µes <strong>Flask</strong>, representando a cl√°ssica comunica√ß√£o entre <strong>front-end =&gt; back-end =&gt; database</strong>. Vamos focar inicialmente em extrair e visualizar M√©tricas, Traces e Logs. Algumas ferramentas foram escolhidas, sendo:</p> <ul> <li><strong>OpenTelemetry, Jaeger, Zipkin e Tempo</strong> para <em>Traces</em>;</li> <li><strong>Loki com Promtail</strong> para <em>Logs</em>;</li> <li><strong>Prometheus + sua Biblioteca Cliente</strong> para <em>M√©tricas</em>;</li> <li><strong>Grafana</strong> para uma visualiza√ß√£o centralizada;</li> </ul> <p>Reposit√≥rio: <a href="https://github.com/apolzek/srerror-observabilidade-na-pratica">srerror-observabilidade-na-pratica</a></p> <p>Antes de partir para o <em>hands on</em>, vamos esclarecer algumas coisas. Quando estamos criando uma API REST certo esfor√ßo √© gasto na parte de <strong>arquitetura e modelagem</strong> de como tudo vai funcionar üë∑üèæ. √â comum uma API REST trabalhar com um banco de dados e se comunicar com outras APIs, seja no modelo de <em>requisi√ß√µes HTTP</em> ou no modelo de <em>Producer/Consumer</em>(mensageria). Quando essa API est√° pronta(com testes eu espero) algu√©m acaba sendo respons√°vel por criar seu Dockerfile, docker-compose e tamb√©m os manifestos do kubernetes. O processo de CI/CD entra em a√ß√£o. Com o deploy conclu√≠do a API passa a receber requisi√ß√µes e tudo que foi modelado √© posto a prova de fogo üî•. Nesse momento entra a <strong>Observabilidade</strong> com um papel muito importante, ela te ajuda a entender os comportamentos internos dos microservi√ßos em intera√ß√£o com suas depend√™ncias üéØ.</p> <p><strong>OpenTelemetry</strong> √© um dos projetos mais promissores no contexto Observabilidade. Otel(apelido carinhoso para OpenTelemetry) √© um padr√£o de c√≥digo aberto √∫nico com um conjunto de tecnologias para capturar e exportar <strong>traces, m√©tricas e logs</strong>. Para te ajudar entender melhor, imagine que esse projeto √© dividido em tr√™s principais partes. A primeira parte refere-se a <strong>Especifica√ß√£o</strong>, ou seja, os padr√µes e nomeclatura utilizados. A segunda parte refere-se as APIs e SDKs. Por fim a terceira parte √© o <strong>Collector</strong>, ele √© um componente externo que serve para <em>receber, processar e enviar</em> os dados de telemetria, fazendo o papel de um centralizador(semelhante a um <em>fluentd</em> da vida). Exemplo:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[API_REST + OTEL(API/SDK)] ====&gt; [OTEL_COLLECTOR] ====&gt; [NEW_RELIC, JAEGER, PROMETHEUS..]
</code></pre></div></div> <blockquote> <p>OBS: Collector funciona tanto no modelo de PUSH quanto de PULL</p> </blockquote> <p>A vantagem de utilizar <strong>Otel</strong> √© que ele foi idealizado para trabalhar com os <strong>3 pilares</strong> da observabilidade de forma agn√≥stica a fornecedor. Nesse exemplo vamos utiliza-lo apenas para parte de Traces.</p> <blockquote> <p>OBS: Otel possui diferentes n√≠veis de maturidade para Traces, Logs e M√©tricas em cada Linguagem de Programa√ß√£o</p> </blockquote> <p>üîé Normalmente algumas coisas que um Desenvolver ou SRE quer üìàsaberüìâ sobre a aplica√ß√£o(<em>seguindo a linha de uma API REST</em>):</p> <ul> <li>Quantidade total de requisi√ß√µes por endpoint/geral</li> <li>Taxa de erros por endpoint/geral</li> <li>Tempo de resposta das requisi√ß√µes por endpoint/geral</li> <li>Rastreamento distribu√≠do(por onde a requisi√ß√£o passou)</li> <li>Logs(stack trace)</li> <li>Porcentagem de logs de level ERROR</li> <li>Intera√ß√£o com Banco de Dados(querys) ou Software de Mensageria</li> <li>Health Check</li> <li>Consumo de CPU e mem√≥ria</li> <li>Relacionar traces, logs e m√©tricas</li> <li>M√©tricas de neg√≥cio</li> </ul> <p>Abaixo est√° como vai funcionar o fluxo para:</p> <p>üìå Traces</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                                                         [Jaeger]
[FLASK(auto-instrumentation)] ===&gt; [OTEL_COLLECTOR] ===&gt; [Tempo]  &lt;=== [Grafana]
                                                         [Zipkin]
</code></pre></div></div> <p>üìå M√©tricas</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[FLASK(prometheus-library)] &lt;=== [OTEL_COLLECTOR] ===&gt; [Prometheus] &lt;=== [Grafana]
</code></pre></div></div> <p>üìå Logs</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[FLASK] &lt;=== [PROMTAIL] ===&gt; [Loki] &lt;=== [Grafana]
</code></pre></div></div> <p>Chega de enrola√ß√£o..<strong>ctrl+alt+t</strong></p> <p>Para facilitar as coisas foi feito o <em>fork</em> de um reposit√≥rio com um exemplo de back-end e front-end em Flask j√° no modelo de Instrumenta√ß√£o Autom√°tica do Otel(SIM, eu n√£o codei a aplica√ß√£o rs). Tamb√©m foi utilizado outro reposit√≥rio como refer√™ncia para a parte de m√©tricas com Prometheus. Todos eles, incluindo o meu, est√£o listados abaixo.</p> <ul> <li>Reposit√≥rio da <strong>aplica√ß√£o Python/Flask</strong> com Otel no modo <em>Automatic Instrumentation</em>: <a href="https://github.com/lciukaj/flask-app-otel">https://github.com/lciukaj/flask-app-otel</a></li> <li>Meu <strong>fork</strong> do reposit√≥rio acima com altera√ß√µes/acr√©scimos: <a href="https://github.com/apolzek/srerror-observabilidade-na-pratica">https://github.com/apolzek/srerror-observabilidade-na-pratica</a></li> <li>Reposit√≥rio de refer√™ncia para parte de <strong>M√©tricas com Prometheus</strong>: <a href="https://github.com/rycus86/prometheus_flask_exporter">https://github.com/rycus86/prometheus_flask_exporter</a></li> </ul> <h4 id="ao-final-a-ideia-√©-ter-algo-assim"> Ao final a ideia √© ter algo assim: <a href="#ao-final-a-ideia-√©-ter-algo-assim">#</a> </h4> <p><img src="https://github.com/apolzek/apolzek.github.io/blob/main/images/Observabilidade-na-pratica/arquitetura.png?raw=true" alt="image" /></p> <blockquote> <p>A posi√ß√£o das setas acima √© uma tentativa de ajudar no entendimento, mas isso muda de acordo com o angulo em que se analisa (configura√ß√£o x rede)</p> </blockquote> <h4 id="partindo-para-pr√°tica"> Partindo para pr√°tica: <a href="#partindo-para-pr√°tica">#</a> </h4> <h5 id="pr√©-requisitos"> Pr√©-requisitos: <a href="#pr√©-requisitos">#</a> </h5> <ul> <li>docker</li> <li>kind</li> <li>helm</li> <li>kubectl</li> <li>make</li> <li>git</li> </ul> <h5 id="minhas-configs"> Minhas configs: <a href="#minhas-configs">#</a> </h5> <ul> <li>Mem√≥ria: 16,0¬†GiB</li> <li>Processador: Intel¬Æ Core‚Ñ¢ i5-9400 CPU @ 2.90GHz √ó 6</li> <li>Disco: SSD 240,1¬†GB</li> <li>OS: Pop!_OS 22.04 LTS</li> </ul> <blockquote> <p>Todos os passos abaixo foram pensados para executar no kubernetes. Eu testei localmente utilizando o kind.</p> </blockquote> <h4 id="-abaixo-est√°-o-passo-a-passo-explicativo"> üßëüèª‚Äçüî¨ Abaixo est√° o passo a passo explicativo <a href="#-abaixo-est√°-o-passo-a-passo-explicativo">#</a> </h4> <p><strong>1</strong> - Clone do reposit√≥rio <em>srerror-observabilidade-na-pratica</em>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/apolzek/srerror-observabilidade-na-pratica.git
cd srerror-observabilidade-na-pratica
</code></pre></div></div> <p><strong>2</strong> - Utilize o make para criar o cluster e fazer deploy das aplica√ß√µes necess√°rias:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make create-cluster
make deploy-mysql
make deploy-jaeger
make deploy-zipkin
make deploy-tempo
make deploy-prometheus
make deploy-grafana
make deploy-loki
</code></pre></div></div> <p>Nesse ponto estamos criando um cluster <strong>kubernetes</strong> üö¢ localmente com o <strong>kind</strong>. A configura√ß√£o define <em>1 control-plane e 3 workers</em>. Depois vamos subir as ferramentas escolhidas. <strong>MySQL</strong> para persist√™ncia dos dados do nosso back-end. <strong>Jaeger e Zipkin</strong> para receber e exibir traces. <strong>Tempo</strong> para receber os traces e servir como datasource no nosso Grafana. <strong>Prometheus</strong> para capturar as m√©tricas e servir tamb√©m como um datasource no Grafana. <strong>Grafana</strong> para fornecer uma visualiza√ß√£o centralizada.</p> <p>‚ùóÔ∏èNota: A ideia de visualiar os mesmos traces em tr√™s lugares diferentes(Grafana, Zipkin e Jaeger) √© proposital. Isso mostra o poder do Collector para exportar dados para m√∫ltiplos destinos.</p> <p><strong>3</strong> - Utilize o make para gerar as imagens da nossa aplica√ß√£o front-end + back-end e fazer o Load/Deploy no kind:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make build
make load-images
make deploy-apps
</code></pre></div></div> <p>O <strong>kind</strong> tem um recurso chamado <em>kind load</em> que permite enviar as imagens locais para serem utilizadas no cluster. vc pode usar um <em>registry</em> remoto desde que fa√ßa as devidas alera√ß√µes nos arquivos de deployment das aplica√ß√µes.</p> <p><img src="https://github.com/apolzek/apolzek.github.io/blob/main/images/Observabilidade-na-pratica/pods.png?raw=true" alt="image" /></p> <p><strong>4</strong> Deploy do <strong>OpenTelemetry Collector</strong> para capturar/receber <em>m√©tricas e traces</em> e envia-los para os destinos escolhidos</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make deploy-collector
</code></pre></div></div> <p>A ideia de fazer o deploy do Otel Collector por √∫ltimo √© que se os componentes listados no seu arquivo de configura√ß√£o n√£o estiverem UP ele retorna algumas mensagens de erro.</p> <p><strong>5</strong> - Visualizar e testar nossas configura√ß√µes:</p> <p>‚ùóÔ∏èNota: N√£o criamos nenhum deploy com service do tipo <strong>Load Balancer</strong> ou <strong>Node Port</strong>. Para os testes locais eu simplesmente utilizei o recurso de port-forward do kubernetes.</p> <p>üñ• Port-forward do <strong>front-end</strong> da nossa aplica√ß√£o:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward svc/flask-app-otel-frontend 5000:5000 &amp;
</code></pre></div></div> <p>Acesse: <a href="http://localhost:5000">http://localhost:5000</a></p> <p><img src="https://github.com/apolzek/apolzek.github.io/blob/main/images/Observabilidade-na-pratica/frontend-flask.png?raw=true" alt="image" /></p> <p>üñ• Port-forward <strong>Grafana</strong> UI:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward svc/grafana 3000:80 &amp;
</code></pre></div></div> <p>Acesse: <a href="http://localhost:3000">http://localhost:3000</a></p> <p>Para obter a senha de acesso do grafana vc pode usar o comando <code class="language-plaintext highlighter-rouge">make get-grafana-pass</code> estando dentro da pasta do reposit√≥rio <em>srerror-observabilidade-na-pratica</em>.</p> <p>üñ• Port-forward UI do <strong>Jaeger</strong>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward svc/jaeger-all-in-one 16686:16686 &amp;
</code></pre></div></div> <p>Acesse: <a href="http://localhost:16686">http://localhost:16686</a></p> <p>üñ• Port-forward UI do <strong>Zipkin</strong>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward svc/zipkin-svc 9411:9411 &amp;
</code></pre></div></div> <p>Acesse: <a href="http://localhost:9411">http://localhost:9411</a></p> <p><strong>6</strong> - Agora vamos entender como tudo est√° funcionando.</p> <p><img src="https://media.giphy.com/media/Zvgb12U8GNjvq/giphy.gif" alt="giphy" /></p> <p><strong>6.1</strong> Para <strong>traces</strong> foi utilizado OpenTelemetry no modo auto-instrumentation. Isso pode ser visto na parte de <strong>CMD</strong> <em>Dockerfile</em> do front-end e back-end.</p> <p>Ex:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM python:3.8-slim

WORKDIR /app

ADD . /app

RUN pip install -r requirements.txt
RUN opentelemetry-bootstrap --action=install

EXPOSE 5001

CMD [ "opentelemetry-instrument", "--resource_attributes", \
    "service.namespace=flask-otel-test,service.name=backend", "--traces_exporter", "otlp", \
    "--exporter_otlp_endpoint", "http://otel-collector:4317", \
    "python3", "app.py"]
</code></pre></div></div> <p>Perceba que estamos utilizando o protocolo <strong>otlp</strong> e definindo o <strong>Collecor</strong> como nosso endpoint de envio. A configura√ß√£o do Collector mostra nossos <em>receivers</em> os <em>exporters</em>. Nesse caso a aplica√ß√£o envia os Traces para o Collector que por sua vez processa os dados e encaminha para 3 diferentes destinos(Tempo, Jaeger e Zipkin). Confira abaixo o mesmo trace em 3 diferentes UI‚Äôs:</p> <p><img src="https://github.com/apolzek/apolzek.github.io/blob/main/images/Observabilidade-na-pratica/tempo.png?raw=true" alt="image" /></p> <p><img src="https://github.com/apolzek/apolzek.github.io/blob/main/images/Observabilidade-na-pratica/zipkin.png?raw=true" alt="image" /></p> <p><img src="https://github.com/apolzek/apolzek.github.io/blob/main/images/Observabilidade-na-pratica/jaeger.png?raw=true" alt="image" /></p> <p>Configura√ß√£o do Collector(<em>k8s/otel-collector.yaml</em>):</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>data:
  otel-collector-config: |
    receivers:
      otlp:
        protocols:
          grpc:
          http:
      prometheus:
        config:
          scrape_configs:
            - job_name: "otel-collector"
              scrape_interval: 5s
              static_configs:
                - targets: ["otel-collector:8888"]
            - job_name: "flask-collector"
              scrape_interval: 5s
              static_configs:
                - targets: ["flask-app-otel-backend:5001"]
    processors:
      batch:
        timeout: 30s
        send_batch_size: 90
    exporters:
      logging:
        loglevel: debug
      zipkin:
        endpoint: "http://zipkin-svc:9411/api/v2/spans"
        format: proto
      jaeger:
        endpoint: ":14250"
        tls:
          insecure: true
      otlp:
        endpoint: "tempo:4317"
        tls:
          insecure: true
      prometheusremotewrite:
        endpoint: "http://prometheus-kube-prometheus-prometheus.default:9090/api/v1/write"
        tls:
          insecure: true
</code></pre></div></div> <p>Arquivo completo: <a href="https://github.com/apolzek/srerror-observabilidade-na-pratica/blob/master/k8s/otel-collector.yaml">https://github.com/apolzek/srerror-observabilidade-na-pratica/blob/master/k8s/otel-collector.yaml</a></p> <p><strong>6.2</strong> Para <strong>m√©tricas</strong> estamos utilizando a biblioteca <strong>prometheus_flask_exporter</strong>. Ela foi elaborada exclusivamente para trabalhar com o framework Flask e facilita muito nosso trabalho. Um simples <code class="language-plaintext highlighter-rouge">pip install</code> resolveu. Utilizando ela nossa aplica√ß√£o back-end passa a export um <em>/metrics</em>. Nesse endpoint fazemos o scrape das m√©tricas. Eu optei por fazer pelo OpenTelemetry e depois enviar para o Prometheus. Apesar de n√£o ser a melhor forma achei interessante fazer assim para enriquecer a demonstra√ß√£o.</p> <p><img src="https://github.com/apolzek/apolzek.github.io/blob/main/images/Observabilidade-na-pratica/metrics.png?raw=true" alt="image" /></p> <p>Veja vc mesmo:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl port-forward svc/flask-app-otel-backend 5001:5001 &amp;
</code></pre></div></div> <p>Agora vc pode criar <em>dashboards</em> no <strong>Grafana</strong> utilizando o <strong>Prometheus</strong> como datasource. Eu deixei um dash de exemplo em <em>k8s/dashboards/example.json</em>. Basta fazer o import:</p> <p><img src="https://github.com/apolzek/apolzek.github.io/blob/main/images/Observabilidade-na-pratica/dashboard.png?raw=true" alt="image" /></p> <p><strong>6.3</strong> Para <strong>logs</strong> utilizamos o <strong>Promtail</strong>(scrape) e <strong>Loki</strong>. Por padr√£o eles j√° conseguem ler os logs de todos os pods no Namespace. Eu configurei o Loki como datasource no Grafana, ent√£o basta partir pro teste. Se vc encontrar algum problema no deploy do Loki(rs), tente rodar o comando abaixo e matar os pods manualmente:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo sysctl fs.inotify.max_user_instances=8192
</code></pre></div></div> <p>Qaulquer log em <em>stdout</em> vai ser capturado pelo Promtail e enviado para o Loki. Veja abaixo:</p> <p><img src="https://github.com/apolzek/apolzek.github.io/blob/main/images/Observabilidade-na-pratica/logs.png?raw=true" alt="image" /></p> <p><strong>7</strong> Analisando os resultados:</p> <ul> <li>O modelo Automatic Instrumentation para Python/Flask teve alguns problemas ao habilitar a flag <em>debug=True</em>.</li> <li>O Otel Collector conseguiu fazer o scrape das m√©tricas da aplica√ß√£o(back-end) Flask e enviar para o Prometheus atrav√©s do <em>prometheusremotewrite</em>.</li> <li>Essas configura√ß√µes atuais n√£o garantem o <em>correlate</em> entre M√©tricas, Logs e Traces.</li> <li>Trabalhamos com observabilidade da aplica√ß√£o mas n√£o fizemos o feij√£o com arroz do monitoramento de Infra.</li> <li>A configura√ß√£o <em>opentelemetry-bootstrap</em> fica apenas no Dockerfile e n√£o √© notada no c√≥digo da aplica√ß√£o.</li> <li>Conseguimos uma forma de visualizar M√©tricas, Logs e Traces em um lugar s√≥(Grafana).</li> </ul> <p><strong>Refer√™ncias:</strong></p> <ul> <li>https://github.com/rycus86/prometheus_flask_exporter/tree/master/examples/sample-signals</li> <li>https://blog.viktoradam.net/2020/05/11/prometheus-flask-exporter/</li> <li>https://github.com/lciukaj/flask-app-otel)</li> <li>https://github.com/rycus86/prometheus_flask_exporter</li> </ul> </section> <section> <nav class="post-nav"> </nav> </section> </main> <script> function setTheme(theme) { if (theme === "dark") { document.documentElement.setAttribute('data-theme', 'dark'); window.localStorage.setItem('theme', 'dark'); document.getElementById("theme-toggle").classList.add('sun'); document.getElementById("theme-toggle").classList.remove('moon'); } else { document.documentElement.setAttribute('data-theme', 'light'); window.localStorage.setItem('theme', 'light'); document.getElementById("theme-toggle").classList.add('moon'); document.getElementById("theme-toggle").classList.remove('sun'); } } let theme = localStorage.getItem('theme'); theme = theme || (window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light' : 'light'); setTheme(theme); function modeSwitcher() { let currentMode = document.documentElement.getAttribute('data-theme'); if (currentMode === "dark") { setTheme('light'); } else { setTheme('dark'); } } </script> <script src="https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js"></script> <script>addBackToTop({ diameter: 48, backgroundColor: 'rgb(196, 187, 240)', textColor: 'black' }) </script> </body> <footer class="social-footer"> <div class="social-footer-icons"> <a href="https://telegram.me/apolzek" title="dm me" target="_blank" rel="noopener noreferrer"><i class="fa fa-telegram" aria-hidden="true"></i></a> <!-- <a href="mailto:p0wex@pm.me" title="Email me"><i class="fa fa-envelope" aria-hidden="true"></i></a> <a href="https://github.com/P0WEX" title="Github profile, nothing much there, yet" target="_blank" rel="noopener noreferrer"><i class="fa fa-github" aria-hidden="true"></i></a> <a href="/atom.xml" title="RSS feed" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss" aria-hidden="true"></i></a> <a href="https://github.com/P0WEX/Gesko" title="Browse the code" target="_blank" rel="noopener noreferrer"><i class="fa fa-code" aria-hidden="true"></i></a> --> </div> </footer> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-61LXK24CDY"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-61LXK24CDY'); </script> </html>
